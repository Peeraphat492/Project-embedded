<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Room Booking - Time Selection</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      animation: moveGrid 20s linear infinite;
    }

    @keyframes moveGrid {
      0% { transform: translate(0, 0); }
      100% { transform: translate(10px, 10px); }
    }
 
    .container {
      width: 100%;
      max-width: 450px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 25px 45px rgba(0, 0, 0, 0.2);
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
 
    /* Header */
    .header {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      backdrop-filter: blur(10px);
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20px;
      right: 20px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
    }
 
    .header button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
      margin-right: 15px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
 
    .header button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .header button:active {
      transform: scale(0.95);
    }
 
    .header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      flex-grow: 1;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.5px;
    }
 
    /* Room Info Section */
    .room-info {
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .room-info h3 {
      font-size: 18px;
      color: #2d3748;
      margin: 0;
      font-weight: 600;
    }

    .room-info p {
      font-size: 14px;
      color: #718096;
      margin: 0;
    }

    /* Times Grid */
    .times {
      padding: 25px 20px;
      flex-grow: 1;
      background: rgba(255, 255, 255, 0.05);
    }
 
    .time-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      animation: fadeIn 0.8s ease-out 0.2s both;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
 
    .time-slot {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      color: #2d3748;
    }

    .time-slot::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
 
    .time-slot:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: rgba(102, 126, 234, 0.5);
    }

    .time-slot:hover::before {
      opacity: 1;
    }
 
    .time-slot.selected {
      border: 2px solid #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      color: #667eea;
      font-weight: 600;
      transform: translateY(-4px);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2), 
                  0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .time-slot.selected::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 12px;
      color: #667eea;
    }
 
    .time-slot:active {
      transform: translateY(-2px) scale(0.98);
      transition: transform 0.1s ease-in-out;
    }

    .time-slot.unavailable {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .time-slot.unavailable:hover {
      transform: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
 
    /* Footer */
    .footer {
      padding: 25px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      position: relative;
    }

    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 20px;
      right: 20px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
    }
 
    .footer button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .footer button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .footer button:hover::before {
      left: 100%;
    }
 
    .footer button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .footer button:active {
      transform: translateY(0);
    }

    .footer button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .footer button.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .footer button.success:hover {
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
    }

    /* Loading states */
    .loading-times {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #718096;
      grid-column: 1/-1;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-times {
      grid-column: 1/-1;
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }

    .empty-times i {
      font-size: 48px;
      color: #cbd5e0;
      margin-bottom: 15px;
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      .container {
        max-width: 100%;
        min-height: 100vh;
      }
      
      .header {
        padding: 15px;
      }
      
      .header h2 {
        font-size: 18px;
      }
      
      .times {
        padding: 20px 15px;
      }
      
      .time-grid {
        gap: 12px;
      }
      
      .time-slot {
        padding: 12px 8px;
        font-size: 13px;
      }
      
      .footer {
        padding: 20px 15px;
      }
      
      .footer button {
        padding: 12px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <button onclick="window.location.href='rooms.html'">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h2>Select Time</h2>
    </div>

<<<<<<< HEAD
    
=======
    <!-- Room Info -->
    <div class="room-info" id="roomInfo">
      <h3 id="roomName">Loading room...</h3>
    </div>
 
    <!-- Time Selection -->
>>>>>>> origin/main
    <div class="times">
      <div class="time-grid" id="timeGrid">
        <!-- Loading state -->
        <div class="loading-times" id="loadingState">
          <div class="loading-spinner"></div>
          <p>Loading available times...</p>
        </div>
      </div>
    </div>
 
    <!-- Footer -->
    <div class="footer">
      <button onclick="continueBooking()" id="continueBtn">
        <i class="fas fa-clock"></i>
        Continue Booking
      </button>
    </div>
  </div>
 
  <script>
    // API configuration
    const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000/api'
      : `http://${window.location.hostname}:3000/api`;
 
    let selectedRoom = null;
    let selectedTime = null;
    let availableSlots = [];
 
    // Utility functions
    const utils = {
      isLoggedIn() {
        return !!localStorage.getItem('token');
      },
      getCurrentUser() {
        const userStr = localStorage.getItem('user');
        return userStr ? JSON.parse(userStr) : null;
      },
      formatDate(date) {
        return date.toISOString().split('T')[0];
      }
    };
 
    // Default time slots (fallback)
    const defaultTimeSlots = [
      { start: '08:00', end: '09:00' },
      { start: '09:00', end: '10:00' },
      { start: '10:00', end: '11:00' },
      { start: '11:00', end: '12:00' },
      { start: '12:00', end: '13:00' },
      { start: '13:00', end: '14:00' },
      { start: '14:00', end: '15:00' },
      { start: '15:00', end: '16:00' },
      { start: '16:00', end: '17:00' },
      { start: '17:00', end: '18:00' },
      { start: '18:00', end: '19:00' },
      { start: '19:00', end: '20:00' },
      { start: '20:00', end: '21:00' },
      { start: '21:00', end: '22:00' },
      { start: '22:00', end: '23:00' },
      { start: '23:00', end: '00:00' }
    ];
 
    // Load selected room data
    function loadRoomData() {
      // Check authentication first
      if (!utils.isLoggedIn()) {
        console.log('Not logged in, redirecting to login');
        alert('⚠️ กรุณาล็อกอินก่อนทำการจอง');
        window.location.href = "login.html";
        return false;
      }
 
      const roomData = localStorage.getItem("selectedRoom");
      if (roomData) {
        selectedRoom = JSON.parse(roomData);
      } else {
        // Fallback to old method
        selectedRoom = {
          id: localStorage.getItem("roomId") || '1',
          name: localStorage.getItem("roomName") || 'Meeting Room1',
          image_url: localStorage.getItem("roomImg")
        };
      }
 
      if (!selectedRoom) {
        alert('ไม่พบข้อมูลห้องที่เลือก กรุณาเลือกห้องใหม่');
        window.location.href = "rooms.html";
        return false;
      }
      
      // Update UI with room info
      updateRoomInfo();
      console.log('Selected room:', selectedRoom);
      return true;
    }

    function updateRoomInfo() {
      const roomNameEl = document.getElementById('roomName');
      const currentDateEl = document.getElementById('currentDate');
      
      if (roomNameEl && selectedRoom) {
        roomNameEl.textContent = selectedRoom.name;
      }
      
      if (currentDateEl) {
        const today = new Date();
        const dateStr = today.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        currentDateEl.innerHTML = `<i class="fas fa-calendar-day"></i><span>${dateStr}</span>`;
      }
    }
 
    // Load available time slots
    async function loadAvailableSlots() {
      try {
        // Try to get from backend first
        const today = new Date();
        const dateStr = utils.formatDate(today);
        
        const response = await fetch(`${API_BASE_URL}/rooms/${selectedRoom.id}/availability/${dateStr}`);
        
        if (response.ok) {
          availableSlots = await response.json();
          console.log('Loaded availability from backend:', availableSlots);
        } else {
          throw new Error('Backend not available');
        }
      } catch (error) {
        console.log('Using default time slots (backend not available)');
        // Use default time slots as fallback
        availableSlots = defaultTimeSlots;
      }
      
      updateTimeSlots();
    }
 
    function updateTimeSlots() {
      const timeGrid = document.getElementById('timeGrid');
      const loadingState = document.getElementById('loadingState');
      
      if (!timeGrid) return;

      // Hide loading state
      if (loadingState) {
        loadingState.style.display = 'none';
      }
 
      // Clear existing slots
      timeGrid.innerHTML = '';
 
      // Create time slots based on availability
      if (availableSlots.length === 0) {
        timeGrid.innerHTML = `
          <div class="empty-times">
            <i class="fas fa-clock"></i>
            <h4>No Available Times</h4>
            <p>ไม่มีช่วงเวลาว่างสำหรับวันนี้</p>
          </div>
        `;
        return;
      }

      availableSlots.forEach((slot, index) => {
        const slotElement = document.createElement('div');
        slotElement.className = 'time-slot';
        slotElement.innerHTML = `
          <div class="time-text">${slot.start} - ${slot.end}</div>
        `;
        slotElement.style.animationDelay = `${index * 0.1}s`;
        slotElement.onclick = () => selectTime(slotElement, slot);
        timeGrid.appendChild(slotElement);
      });
    }
 
    function selectTime(slot, timeData) {
      if (selectedTime) {
        selectedTime.classList.remove("selected");
      }
      slot.classList.add("selected");
      selectedTime = slot;

      // Update button state
      const continueBtn = document.getElementById('continueBtn');
      continueBtn.classList.add('success');
      continueBtn.innerHTML = '<i class="fas fa-check-circle"></i> Time Selected - Continue';
 
      // Store selected time data
      const now = new Date();
      const day = now.getDate();
      const month = now.toLocaleString('en-US', { month: 'long' });
      const year = now.getFullYear();
 
      const formattedDateTime = `${day} ${month} ${year}, ${timeData.start} - ${timeData.end}`;
      localStorage.setItem("bookingDateTime", formattedDateTime);
      localStorage.setItem("selectedTimeSlot", JSON.stringify(timeData));
      
      // Show success feedback
      showNotification(`Selected: ${timeData.start} - ${timeData.end}`, 'success');
      console.log('Selected time:', formattedDateTime);
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #3b82f6, #1d4ed8)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        font-weight: 500;
        font-size: 14px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.style.transform = 'translateX(0)', 100);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 2500);
    }
 
    async function continueBooking() {
      console.log('continueBooking function called');
      
      if (!selectedTime) {
        console.log('No time selected');
        showNotification("⚠️ Please select a time slot first", "warning");
        
        // Shake animation for unselected time slots
        const timeSlots = document.querySelectorAll('.time-slot');
        timeSlots.forEach(slot => {
          slot.style.animation = 'shake 0.5s ease-in-out';
          setTimeout(() => {
            slot.style.animation = '';
          }, 500);
        });
        return;
      }

      console.log('Time selected, proceeding with booking');

      try {
        // Show loading
        const continueBtn = document.getElementById('continueBtn');
        const originalContent = continueBtn.innerHTML;
        continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Booking...';
        continueBtn.disabled = true;

        // Get time slot data
        const timeSlot = JSON.parse(localStorage.getItem("selectedTimeSlot"));
        const today = new Date();
        const dateStr = utils.formatDate(today);

        console.log('Creating booking with data:', { timeSlot, selectedRoom });

        // Always create fallback booking for now (to ensure it works)
        const user = utils.getCurrentUser();
        const fallbackBooking = {
          id: Date.now(),
          room_id: parseInt(selectedRoom.id),
          room_name: selectedRoom.name,
          room_image: selectedRoom.image_url,
          booking_date: dateStr,
          start_time: timeSlot.start,
          end_time: timeSlot.end,
          username: user ? user.username : 'Admin',
          access_code: Math.floor(100000 + Math.random() * 900000),
          created_at: new Date().toISOString()
        };
        
        localStorage.setItem("bookingResult", JSON.stringify(fallbackBooking));
        console.log('Created booking:', fallbackBooking);
        
        showNotification('Booking confirmed! 🎉', 'success');
        
        // Navigate after a short delay
        console.log('Navigating to summary.html in 1.5 seconds...');
        setTimeout(() => {
          console.log('Navigating now!');
          window.location.href = "summary.html";
        }, 1500);
        
      } catch (error) {
        console.error('Error in continueBooking:', error);
        showNotification(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
        
        // Reset button
        const continueBtn = document.getElementById('continueBtn');
        continueBtn.innerHTML = '<i class="fas fa-clock"></i> Continue Booking';
        continueBtn.disabled = false;
      }
    }

    // Add shake animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }
    `;
    document.head.appendChild(style);
 
    // Initialize page
    window.addEventListener('DOMContentLoaded', () => {
      const roomLoaded = loadRoomData();
      if (roomLoaded !== false) {
        loadAvailableSlots();
      }
    });
  </script>
</body>
</html>
 