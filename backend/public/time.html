<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Room Booking - Time Selection</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display:flex; justify-content:center; min-height:100vh; position:relative; overflow-x:hidden;
    }
    body::before {
      content:''; position:absolute; top:0; left:0; right:0; bottom:0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      animation: moveGrid 20s linear infinite;
    }
    @keyframes moveGrid { 0%{transform:translate(0,0);} 100%{transform:translate(10px,10px);} }

    .container {
      width:100%; max-width:450px; background:rgba(255,255,255,0.95); backdrop-filter:blur(20px);
      min-height:100vh; display:flex; flex-direction:column; position:relative; z-index:1;
      border:1px solid rgba(255,255,255,0.3); box-shadow:0 25px 45px rgba(0,0,0,0.2); animation:fadeInUp .8s ease-out;
    }
    @keyframes fadeInUp { from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }

    .header {
      display:flex; align-items:center; padding:20px; border-bottom:1px solid rgba(255,255,255,0.2);
      background:linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
      backdrop-filter: blur(10px); position:relative;
    }
    .header::after { content:''; position:absolute; bottom:0; left:20px; right:20px; height:1px; background:linear-gradient(90deg, transparent, rgba(102,126,234,0.3), transparent); }

    .header button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; font-size:18px; cursor:pointer;
      margin-right:15px; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      transition:all .3s ease; box-shadow:0 4px 15px rgba(102,126,234,0.3);
    }
    .header button:hover { transform:scale(1.1); box-shadow:0 6px 20px rgba(102,126,234,0.4); }
    .header h2 {
      margin:0; font-size:20px; font-weight:600; flex-grow:1; text-align:center;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      background-clip:text; letter-spacing:0.5px;
    }

    .room-info { padding:15px 20px; background:rgba(255,255,255,0.1); border-bottom:1px solid rgba(255,255,255,0.1); text-align:center; }
    .room-info h3 { font-size:18px; color:#2d3748; margin:0; font-weight:600; }
    .room-info p { font-size:14px; color:#718096; margin:0; }

    .times { padding:25px 20px; flex-grow:1; background:rgba(255,255,255,0.05); }
    .time-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; animation:fadeIn .8s ease-out .2s both; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

    .time-slot {
      border:2px solid rgba(255,255,255,0.3); border-radius:12px; padding:15px 10px; text-align:center; cursor:pointer;
      font-size:14px; font-weight:500; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px);
      transition: all .3s ease; position:relative; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.1); color:#2d3748;
      user-select:none;
    }
    .time-slot:focus { outline: 3px solid rgba(102,126,234,0.25); }
    .time-slot::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); opacity:0; transition:opacity .3s ease; }
    .time-slot:hover { transform:translateY(-4px); box-shadow:0 8px 25px rgba(0,0,0,0.15); border-color:rgba(102,126,234,0.5); }
    .time-slot:hover::before { opacity:1; }
    .time-slot.selected {
      border:2px solid #667eea; background:linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
      color:#667eea; font-weight:600; transform:translateY(-4px); box-shadow:0 0 0 4px rgba(102,126,234,0.2), 0 8px 25px rgba(0,0,0,0.15);
    }
    .time-slot.selected::after {
      content:'\f00c'; font-family:'Font Awesome 6 Free'; font-weight:900; position:absolute; top:8px; right:8px; font-size:12px; color:#667eea;
    }
    .time-slot:active { transform:translateY(-2px) scale(0.98); transition:transform .1s ease-in-out; }

    .time-slot.unavailable {
      background:rgba(239,68,68,0.05); border-color:rgba(239,68,68,0.2); color:#ef4444; cursor:not-allowed; opacity:0.7;
      transform:none; box-shadow:none;
    }

    .footer { padding:25px 20px; border-top:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.5); backdrop-filter:blur(10px); position:relative; }
    .footer button { width:100%; padding:15px; border:none; border-radius:12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-size:16px; font-weight:600; cursor:pointer; transition:all .3s ease; position:relative; overflow:hidden; box-shadow:0 4px 15px rgba(102,126,234,0.4); display:flex; align-items:center; justify-content:center; gap:8px; }
    .footer button::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition:left .5s ease; }
    .footer button:hover::before { left:100%; }
    .footer button:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,0.6); }
    .footer button:active { transform:translateY(0); }
    .footer button:disabled { opacity:0.6; cursor:not-allowed; transform:none !important; }

    .footer button.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16,185,129,0.4); }
    .footer button.success:hover { box-shadow:0 6px 20px rgba(16,185,129,0.6); }

    .loading-times { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; color:#718096; grid-column:1/-1; }
    .loading-spinner { width:40px; height:40px; border:3px solid rgba(102,126,234,0.3); border-top:3px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:15px; }
    @keyframes spin { 0% { transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }

    .empty-times { grid-column:1/-1; text-align:center; padding:40px 20px; color:#718096; }
    .empty-times i { font-size:48px; color:#cbd5e0; margin-bottom:15px; }

    @media (max-width:480px) {
      .container { max-width:100%; min-height:100vh; }
      .header { padding:15px; }
      .header h2 { font-size:18px; }
      .times { padding:20px 15px; }
      .time-grid { gap:12px; }
      .time-slot { padding:12px 8px; font-size:13px; }
      .footer { padding:20px 15px; }
      .footer button { padding:12px; font-size:15px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <!-- Header -->
    <div class="header">
      <button id="backBtn" aria-label="Back to rooms">
        <i class="fas fa-arrow-left" aria-hidden="true"></i>
      </button>
      <h2>Select Time</h2>
    </div>

    <!-- Room Info -->
    <div class="room-info" id="roomInfo">
      <h3 id="roomName">Meeting Room</h3>
      <p id="currentDate" aria-live="polite">⚡ ช่วงเวลาครบ 24 ชั่วโมง - เลือกได้ทันที!</p>
    </div>

    <!-- Time Selection -->
    <div class="times">
      <div class="time-grid" id="timeGrid">
        <!-- ช่วงเวลาจะแสดงทันทีโดย JavaScript -->
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <button onclick="continueBooking()" id="continueBtn" aria-label="Continue Booking">
        <i class="fas fa-clock" aria-hidden="true"></i>
        Continue Booking
      </button>
    </div>
  </div>

  <script>
    // -------------------------------
    // API configuration
    // -------------------------------
    const API_BASE_URL = (() => {
      const host = window.location.hostname;
      if (host === "localhost" || host === "127.0.0.1") {
        return "http://localhost:3000/api";
      }
      if (host.includes("vercel.app")) {
        return `https://${host}/api`;
      }
      // default: same host but ensure protocol + host used (works for deployed static + API under /api)
      return `${window.location.protocol}//${window.location.hostname}/api`;
    })();

    // -------------------------------
    // State
    // -------------------------------
    let selectedRoom = null;
    let selectedTimeSlotElem = null; // DOM element of selected slot
    let availableSlots = [];

    // -------------------------------
    // Utilities
    // -------------------------------
    const utils = {
      isLoggedIn() {
        return !!localStorage.getItem('token');
      },
      getCurrentUser() {
        const userStr = localStorage.getItem('user');
        return userStr ? JSON.parse(userStr) : null;
      },
      // format local date as YYYY-MM-DD (local timezone)
      formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      },
      // friendly long date to show on UI
      prettyLongDate(date) {
        return date.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      }
    };

    // Default fallback slots - 24 ชั่วโมง แสดงทันที
    const defaultTimeSlots = [
      { start:'00:00', end:'01:00' }, { start:'01:00', end:'02:00' }, { start:'02:00', end:'03:00' },
      { start:'03:00', end:'04:00' }, { start:'04:00', end:'05:00' }, { start:'05:00', end:'06:00' },
      { start:'06:00', end:'07:00' }, { start:'07:00', end:'08:00' }, { start:'08:00', end:'09:00' },
      { start:'09:00', end:'10:00' }, { start:'10:00', end:'11:00' }, { start:'11:00', end:'12:00' },
      { start:'12:00', end:'13:00' }, { start:'13:00', end:'14:00' }, { start:'14:00', end:'15:00' },
      { start:'15:00', end:'16:00' }, { start:'16:00', end:'17:00' }, { start:'17:00', end:'18:00' },
      { start:'18:00', end:'19:00' }, { start:'19:00', end:'20:00' }, { start:'20:00', end:'21:00' },
      { start:'21:00', end:'22:00' }, { start:'22:00', end:'23:00' }, { start:'23:00', end:'00:00' }
    ];

    // -------------------------------
    // Page boot / load room
    // -------------------------------
    function loadRoomData() {
      // ไม่บังคับ login ในขั้นตอนดูเวลา - เช็คตอนจองเท่านั้น
      const roomData = localStorage.getItem("selectedRoom");
      if (roomData) {
        try {
          selectedRoom = JSON.parse(roomData);
        } catch (e) {
          selectedRoom = { id:'1', name:'Meeting Room 1' };
        }
      } else {
        selectedRoom = {
          id: localStorage.getItem("roomId") || '1',
          name: localStorage.getItem("roomName") || 'Meeting Room 1',
          image_url: localStorage.getItem("roomImg") || ''
        };
      }

      updateRoomInfo();
      console.log('Selected room:', selectedRoom);
      return true;
    }

    function updateRoomInfo() {
      const roomNameEl = document.getElementById('roomName');
      const currentDateEl = document.getElementById('currentDate');

      if (roomNameEl && selectedRoom) roomNameEl.textContent = selectedRoom.name;

      if (currentDateEl) {
        const today = new Date();
        currentDateEl.innerHTML = `<i class="fas fa-calendar-day" aria-hidden="true"></i> <span>${utils.prettyLongDate(today)}</span>`;
      }
    }

    // -------------------------------
    // Load availability - แสดงทันทีไม่รอ API
    // -------------------------------
    function loadAvailableSlots() {
      console.log('⚡ แสดงช่วงเวลาทันที - ไม่รอ database');
      
      // แสดงช่วงเวลาทันทีโดยไม่เรียก API
      availableSlots = defaultTimeSlots.map(s => ({ 
        start: s.start, 
        end: s.end, 
        unavailable: false 
      }));
      
      console.log('✅ แสดงช่วงเวลาแล้ว:', availableSlots.length, 'ช่วง');
      updateTimeSlots();
    }

    // -------------------------------
    // Render time slots
    // -------------------------------
    function updateTimeSlots() {
      const timeGrid = document.getElementById('timeGrid');
      if (!timeGrid) return;

      timeGrid.innerHTML = '';

      if (!Array.isArray(availableSlots) || availableSlots.length === 0) {
        timeGrid.innerHTML = `
          <div class="empty-times">
            <i class="fas fa-clock" aria-hidden="true"></i>
            <h4>No Available Times</h4>
            <p>ไม่มีช่วงเวลาว่างสำหรับวันนี้</p>
          </div>
        `;
        return;
      }

      availableSlots.forEach((slot, index) => {
        const slotEl = document.createElement('div');
        slotEl.className = 'time-slot';
        
        // Add time period indicator
        const startHour = parseInt(slot.start.split(':')[0]);
        let period = '';
        let periodColor = '';
        
        if (startHour >= 0 && startHour < 6) {
          period = 'ดึก';
          periodColor = '#6b7280'; // Gray
        } else if (startHour >= 6 && startHour < 12) {
          period = 'เช้า';
          periodColor = '#f59e0b'; // Amber
        } else if (startHour >= 12 && startHour < 18) {
          period = 'บ่าย';
          periodColor = '#3b82f6'; // Blue
        } else {
          period = 'ค่ำ';
          periodColor = '#7c3aed'; // Purple
        }
        
        slotEl.innerHTML = `
          <div class="time-text">${slot.start} - ${slot.end}</div>
          <div class="time-period" style="font-size: 10px; color: ${periodColor}; margin-top: 2px;">${period}</div>
        `;
        slotEl.style.animationDelay = `${index * 0.01}s`; // เร็วมาก

        if (slot.unavailable) {
          slotEl.classList.add('unavailable');
          slotEl.title = 'Unavailable';
        } else {
          slotEl.addEventListener('click', () => selectTime(slotEl, slot));
        }

        timeGrid.appendChild(slotEl);
      });
    }

    // -------------------------------
    // Select time
    // -------------------------------
    function selectTime(slotElem, slotData) {
      // prevent selecting unavailable
      if (!slotData || slotData.unavailable) return;

      if (selectedTimeSlotElem) {
        selectedTimeSlotElem.classList.remove('selected');
        selectedTimeSlotElem.setAttribute('aria-pressed','false');
      }

      slotElem.classList.add('selected');
      slotElem.setAttribute('aria-pressed','true');
      selectedTimeSlotElem = slotElem;

      // Update continue button
      const continueBtn = document.getElementById('continueBtn');
      continueBtn.classList.add('success');
      continueBtn.innerHTML = '<i class="fas fa-check-circle" aria-hidden="true"></i> Time Selected - Continue';

      // Format friendly date/time and save selection
      const now = new Date();
      const day = now.getDate();
      const month = now.toLocaleString('en-US', { month: 'long' });
      const year = now.getFullYear();
      const formattedDateTime = `${day} ${month} ${year}, ${slotData.start} - ${slotData.end}`;

      localStorage.setItem('bookingDateTime', formattedDateTime);
      localStorage.setItem('selectedTimeSlot', JSON.stringify(slotData));

      showNotification(`Selected: ${slotData.start} - ${slotData.end}`, 'success');
      console.log('Selected time:', formattedDateTime);
    }

    // -------------------------------
    // Notification (supports success/warning/error/info)
    // -------------------------------
    function showNotification(message = '', type = 'info') {
      const colors = {
        success: { bg: 'linear-gradient(135deg,#10b981,#059669)' },
        warning: { bg: 'linear-gradient(135deg,#f59e0b,#d97706)' },
        error: { bg: 'linear-gradient(135deg,#ef4444,#dc2626)' },
        info: { bg: 'linear-gradient(135deg,#3b82f6,#1d4ed8)' }
      };
      const style = colors[type] ? colors[type].bg : colors.info.bg;

      const notification = document.createElement('div');
      notification.style.cssText = `
        position:fixed; top:20px; right:20px; background:${style}; color:white; padding:12px 20px; border-radius:8px;
        box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:10000; font-weight:500; font-size:14px;
        transform: translateX(100%); transition: transform 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      // show
      setTimeout(() => notification.style.transform = 'translateX(0)', 80);
      // hide
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => { if (notification && notification.parentNode) notification.parentNode.removeChild(notification); }, 350);
      }, 2500);
    }

    // -------------------------------
    // Continue / create booking
    // -------------------------------
    async function continueBooking() {
      console.log('continueBooking called');

      // require selection
      const slotData = (() => {
        try { return JSON.parse(localStorage.getItem('selectedTimeSlot')); } catch(e) { return null; }
      })();

      if (!slotData) {
        showNotification('⚠️ Please select a time slot first', 'warning');

        // small shake feedback for the grid
        const slots = document.querySelectorAll('.time-slot');
        slots.forEach(s => {
          s.style.animation = 'shake .45s ease-in-out';
          setTimeout(() => { s.style.animation = ''; }, 450);
        });
        return;
      }

      // disable UI
      const continueBtn = document.getElementById('continueBtn');
      const prevContent = continueBtn.innerHTML;
      continueBtn.disabled = true;
      continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Processing Booking...';

      try {
        // เช็ค login เมื่อจะจองจริงเท่านั้น
        const token = localStorage.getItem('token');
        if (!token) {
          showNotification('Please login first to book a room', 'error');
          setTimeout(() => { window.location.href = 'login.html'; }, 1500);
          continueBtn.disabled = false;
          continueBtn.innerHTML = prevContent;
          return;
        }

        const bookingData = {
          room_id: parseInt(selectedRoom.id, 10),
          date: utils.formatDate(new Date()),
          start_time: slotData.start,
          end_time: slotData.end
        };

        console.log('Sending booking:', bookingData);

        const resp = await fetch(`${API_BASE_URL}/bookings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(bookingData)
        });

        const respBody = await safeParseJSON(resp);

        if (!resp.ok) {
          const errMsg = (respBody && (respBody.error || respBody.message)) ? (respBody.error || respBody.message) : `Server returned ${resp.status}`;
          throw new Error(errMsg);
        }

        // success
        const bookingResult = respBody;
        console.log('Booking created:', bookingResult);

        const formattedBooking = {
          id: bookingResult.id,
          room_id: bookingResult.room_id,
          room_name: bookingResult.room_name || selectedRoom.name,
          room_image: selectedRoom.image_url || '',
          booking_date: bookingResult.booking_date || utils.formatDate(new Date()),
          start_time: bookingResult.start_time || slotData.start,
          end_time: bookingResult.end_time || slotData.end,
          username: bookingResult.username || utils.getCurrentUser()?.username || '',
          access_code: bookingResult.access_code || '',
          created_at: bookingResult.created_at || new Date().toISOString()
        };

        localStorage.setItem('bookingResult', JSON.stringify(formattedBooking));
        showNotification('Booking confirmed! 🎉', 'success');

        // navigate to summary (no background work — immediate)
        setTimeout(() => { window.location.href = 'summary.html'; }, 900);

      } catch (err) {
        console.error('Booking error:', err);
        showNotification(`Error: ${err.message || 'Could not create booking'}`, 'error');
        // restore UI
        continueBtn.disabled = false;
        continueBtn.innerHTML = prevContent;
      }
    }

    // safe JSON parse helper
    async function safeParseJSON(response) {
      try {
        return await response.json();
      } catch (e) {
        try {
          const txt = await response.text();
          return { raw: txt };
        } catch (ee) {
          return null;
        }
      }
    }

    // Add shake keyframes (JS injection)
    (function addShakeStyles() {
      const style = document.createElement('style');
      style.textContent = `
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }
      `;
      document.head.appendChild(style);
    })();

    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      try { window.location.href = 'rooms.html'; } catch(e) { history.back(); }
    });

    // Initialize on DOM ready
    window.addEventListener('DOMContentLoaded', () => {
      const ok = loadRoomData();
      if (ok) loadAvailableSlots();
    });
  </script>
</body>
</html>
